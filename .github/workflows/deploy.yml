name: Deploy to SmarterASP via FTP (Working Solution)
on:
  push:
    branches: [ main, master ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Debug Repository Structure
      run: |
        echo "Repository root:"
        ls -la
        echo "Looking for .csproj files:"
        find . -name "*.csproj" -type f
        echo "Looking for solution files:"
        find . -name "*.sln" -type f
        
    - name: Restore, Build & Publish
      run: |
        echo "Building projects in dependency order with correct file names..."
        
        # Remove the problematic solution file to avoid conflicts
        rm -f Trippy.sln
        
        # Build in dependency order using actual GitHub file names
        echo "‚úÖ Building Domain (base layer)..."
        dotnet build Trippy.Domain/Trippy.Domain.csproj --configuration Release
        
        echo "‚úÖ Building Core (infrastructure layer)..."  
        dotnet build Trippy.Core/TRIPPY.CORE.csproj --configuration Release
        
        echo "‚úÖ Building Business (business logic layer)..."
        dotnet build Trippy.Bussiness/TRIPPY.BUSSINESS.csproj --configuration Release
        
        echo "‚úÖ Publishing API (presentation layer)..."
        dotnet publish Trippy.API/TRIPPY.API.csproj --configuration Release --output ./publish --no-build
        
        echo "üìÅ Deployment files ready:"
        find ./publish -type f | wc -l
        echo "üîç Key files:"
        find ./publish -name "*.dll" -o -name "*.json" -o -name "*.config" -o -name "web.config" | head -10
        
        echo "Files ready for deployment:"
        find ./publish -type f | wc -l
        echo "Key files:"
        find ./publish -name "*.dll" -o -name "*.json" -o -name "*.config" -o -name "web.config" | head -10
    
    # 1Ô∏è‚É£ Upload app_offline.htm to stop IIS and unlock DLLs
    - name: Put app_offline.htm (Maintenance Mode)
      run: |
        echo "<h1>Maintenance in progress...</h1>" > app_offline.htm
        curl -T app_offline.htm --user "${{ secrets.WEB_DEPLOY_USERNAME }}:${{ secrets.WEB_DEPLOY_PASSWORD }}" \
        ftp://win8231.site4now.net/trippyapi/app_offline.htm
    
    # 2Ô∏è‚É£ Deploy all files while IIS is stopped
    - name: Deploy to SmarterASP via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: win8231.site4now.net
        username: ${{ secrets.WEB_DEPLOY_USERNAME }}
        password: ${{ secrets.WEB_DEPLOY_PASSWORD }}
        local-dir: ./publish/
        server-dir: /trippyapi/
        port: 21
        protocol: ftp
        timeout: 600000
        log-level: verbose
        exclude: |
          **/.git*
          **/.git*/**
          **/obj/**
          **/*.pdb
          **/ref/**
    
    # 3Ô∏è‚É£ Remove app_offline.htm so IIS restarts with new files
    - name: Delete app_offline.htm
      run: |
        curl -v --user "${{ secrets.WEB_DEPLOY_USERNAME }}:${{ secrets.WEB_DEPLOY_PASSWORD }}" \
        ftp://win8231.site4now.net/trippyapi/app_offline.htm -Q "-DELE /trippyapi/app_offline.htm"
    
    # 4Ô∏è‚É£ Simple confirmation output
    - name: Verify Deployment
      run: |
        echo "‚úÖ Deployment completed! Your API should be available at:"
        echo "üåê http://sreenathganga-001-site13.jtempurl.com/"